production:
  image: registry.gitlab.com/6go/dx/docker/git:latest
  stage: deploy
  environment:
    name: ludo237_website
    url: https://www.ludo237.com
    deployment_tier: production
  needs:
    - job: tag::docker::production
      artifacts: false
  variables:
    SSH_KEY: $COMPUTE_SSH_PRIVATE_KEY
  before_script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo $SSH_KEY >> ~/.ssh/id_ed25519
    - chmod 400 ~/.ssh/id_ed25519
    - eval $(ssh-agent -s)
    - echo "$SSH_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - scp -i ~/.ssh/id_ed25519 -P $COMPUTE_SSH_PORT ./docker/compose.production.yml $COMPUTE_SSH_USER@$COMPUTE_IP:$PRODUCTION_PATH/docker-compose.yml
    - ssh -i ~/.ssh/id_ed25519 -p $COMPUTE_SSH_PORT $COMPUTE_SSH_USER@$COMPUTE_IP "cd $PRODUCTION_PATH && docker compose pull && exit"
    - ssh -i ~/.ssh/id_ed25519 -p $COMPUTE_SSH_PORT $COMPUTE_SSH_USER@$COMPUTE_IP "cd $PRODUCTION_PATH && docker compose up -d --force-recreate && exit"
    - ssh -i ~/.ssh/id_ed25519 -p $COMPUTE_SSH_PORT $COMPUTE_SSH_USER@$COMPUTE_IP "docker exec 237_app php artisan key:generate && exit"
    - ssh -i ~/.ssh/id_ed25519 -p $COMPUTE_SSH_PORT $COMPUTE_SSH_USER@$COMPUTE_IP "docker exec 237_app php artisan migrate --force && exit"
    - ssh -i ~/.ssh/id_ed25519 -p $COMPUTE_SSH_PORT $COMPUTE_SSH_USER@$COMPUTE_IP "docker exec 237_app php artisan optimize && exit"
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
      allow_failure: true
